#!/usr/bin/env python

try:
    import thunder
except ImportError:
    thunder = None
    raise Exception("Unable to import Thunder. Please make sure that the Thunder installation directory is listed in " +
                    "the PYTHONPATH environment variable.")
import glob
import os
import subprocess
import sys

from thunder.utils.launch import getSparkHome, transformArguments


def getStandaloneDir():
    return os.path.join(os.path.dirname(os.path.realpath(thunder.__file__)), "standalone")


def getExampleNames():
    standaloneDir = getStandaloneDir()
    return [os.path.basename(fname)[:-3] for fname in glob.glob(standaloneDir + os.sep + "*.py")]


def printUsage():
    print >> sys.stderr, "usage: thunder-submit-example [spark-submit opts] " + \
                         "<analysis name> [analysis opts]"


def main():
    SPARK_HOME = getSparkHome()

    if len(sys.argv) < 2:
        printUsage()
        exit(1)

    exampleNames = getExampleNames()

    found = False
    childArgs = transformArguments(sys.argv)
    for idx, arg in enumerate(childArgs):
        if arg in exampleNames:
            childArgs[idx] = os.path.join(getStandaloneDir(), arg+".py")
            found = True
            break
    if not found:
        printUsage()
        raise Exception("Did not recognize a known example analysis name; must be a script in %s (one of: %s)" %
                        (getStandaloneDir(), str(getExampleNames())[1:-1]))

    sparkSubmit = os.path.join(SPARK_HOME, 'bin', 'spark-submit')
    childArgs = [sparkSubmit] + childArgs

    subprocess.call(childArgs, env=os.environ)

if __name__ == "__main__":
    main()